# 从一开始搭建json库教程（零）

## 面向真正的新手，从我自己足够菜鸟的角度出发。

当我想用C++做一些自己的项目的时候，搜出来比较简单的项目之中就有JSON库。中文教程中比较多人推荐的应该就是叶劲峰老师的[从零开始的 JSON 库教程](https://zhuanlan.zhihu.com/p/22457315)，老师写得很好，也在每个章节设置了该完成的任务，跟打游戏一样。但对于我这样的新手而言，我想有一个完整的思路，我觉得不够对新手友好把。然后，我在github找到一套使用C++11标准的库[json11](https://github.com/dropbox/json11)。

在研究了一段时间之后，我觉得我可以写一个更详细的使用C++11搭建JSON库的中文教程，我做的这些工作都是站在巨人的肩膀上的一些微小的工作，所以我才把这个教程叫做从**从一开始搭建json库教程**。

写教程的另外一个目的是我了解到最好的学习方法是寓教于学，因为能把项目面向一个真的新手讲清楚，就证明肯定也能面向面试官讲清楚。推荐大家将自己学习的经验写下来，会有助于自己的理解，在这同时能帮到真的需要帮助的朋友那就更好了。如果大佬们有空有幸读到本教程，看出有什么疏漏错误的话，希望在评论区指出，虽然我觉得大佬也不会花时间看这种教程。而且当前这个库完成度肯定是不完善的，字符串也有UTF-8转义没写，但我觉得问题不大，主要是掌握一个思路，实际要加这种转义也不会很难。

我的 JSON 库名为 ghjson，取greenhand菜鸟的意思。

## 当我们在谈论json库的时候，我们在谈论什么？

### 什么是json？

JSON格式是1999年《JavaScript Programming Language, Standard ECMA-262 3rd Edition》的子集合，所以可以在JavaScript以eval()函数（javascript通过eval()调用解析器）读入。不过这并不代表JSON无法使用于其他语言，事实上几乎所有与网络开发相关的语言都有JSON函式库。

JSON 的基本数据类型：

数值：十进制数，不能有前导0，可以为负数，可以有小数部分。还可以用e或者E表示指数部分。不能包含非数，如NaN。不区分整数与浮点数。JavaScript用双精度浮点数表示所有数值。

示例：
~~~
30
~~~
字符串：以双引号""括起来的零个或多个Unicode码位。支持反斜杠开始的转义字符序列。

示例：
~~~
"Jane Doe"
~~~
布尔值：表示为true或者false。

示例：
~~~
true
~~~
数组：有序的零个或者多个值。每个值可以为任意类型。数组使用方括号[]包裹。多个数组元素之间用逗号,分隔，形如：[value, value]。

示例：
~~~
["Bob", "Alice", "John"]
~~~
对象：若干无序的“键-值对”(key-value pairs)，其中键只能是字符串[2]。建议但不强制要求对象中的键是独一无二的。对象以花括号{}包裹。多个键-值对之间使用逗号,分隔。键与值之间用冒号:分隔。

示例：
~~~
{
  "name": "Jane Doe",
  "age": 30,
  "address": {
    "street": "123 Main St",
    "city": "Anytown",
    "zipcode": "12345"
  }
}
~~~
空值：值写为null

示例：
~~~
null
~~~

### json库需要做什么？

我们可以先设想一个使用json库的场景，从我以前能接触的业务出发啊，假设我有一个进程部署在服务器上会随时接受信息。第一，我们跟调用方约定好，用json格式传送数据；第二，调用方通过调用OnStart函数来使用我们的服务，将想要我们这个进程要处理的数据作为OnStart参数传入，类似如下：
~~~cpp
  void OnStart(const char * in)
  {
    //其他处理..
    //解析数据，提供一个parse()接口，并且提供一个在代码中承载json格式的数据结构
    ghjson::Json mess = parse(in);
    //数据处理
  }
~~~
这是我最容易想到的场景，起码就明确了起码的两个需求，第一，库里需要有一个可以在代码中承载json数据的数据结构，第二需要有一个接受一个字符串，并将其按json格式解析返回刚才提到的数据结构。这时我还会想到，在接受完数据后，应该还要处理数据，所以一种可能的代码框架如下：
~~~cpp
  //处理数据
  void DealMessage(ghjson::Json & mess)
  {
    //判断类型
    if(!mess.isObject())
      return ;
    //迭代
    for(auto iter = mess.begin(); iter != mess.end(); iter++)
    {
      //其他处理
      //获取值
      if(iter->first == "number" && iter->second().isNumber())
      {
        //其他处理
        auto num = iter->second.getNumber();
        //其他处理
      }
      //获取值
      else if(iter->first == "token" && iter->second().isString())
      {
        string token;
        //其他处理
        iter->second.setSting(token);
        //其他处理
      }
    }
  }
~~~
当处理完成之后，我可能还需要发送给我的目标，当我发给目标的时候，不能保证对方也调用我的库，以致于只需传送自己定义json数据结构即可。我们需要将待发送的json格式数据整理成一个字符串：
~~~cpp
  void PostMess(ghjson::json mess)
  {
    //其他处理
    string result = mess.dump();
    post(result);
    //其他处理
  }
~~~
到此为止，我已经大概理清楚在我的认知中，这个json库应该具备的功能，以及接下来我们准备要开始的工作：

1、**构建 JSON 数据结构**：使用C++代码设计和表示 JSON 数据结构，包括对象、数组等。

2、**提供操作接口**：完善数据结构的对外操作接口，包括但不限于类型判断，增加值，删除值，查询值，修改值。

3、**搭建 ``parse()`` 接口**：编写解析函数，负责将 JSON 格式的字符串转换为程序内部的 JSON 数据结构。

4、**搭建 ``dump()`` 接口**：编写序列化函数，负责将程序内部的 JSON 数据结构转换为 JSON 格式的字符串。
